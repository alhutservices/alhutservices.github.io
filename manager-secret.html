<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ≠Ÿàÿ™ ÿßŸÑÿπŸÑŸäÿß üëë</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Space+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { 
            font-family: 'Tajawal', sans-serif; 
            background: #00050a; 
            color: #e2e8f0; 
            background-image: radial-gradient(circle at 50% 50%, #001529 0%, #00050a 100%);
            min-height: 100vh;
        }

        /* ÿÆŸÑŸÅŸäÿ© ÿ¥ÿ®ŸÉÿ© ÿßŸÑÿ≠Ÿàÿ≥ÿ®ÿ© */
        body::before {
            content: ""; position: fixed; inset: 0;
            background-image: linear-gradient(rgba(0, 242, 255, 0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 242, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px; z-index: -1;
        }

        .admin-card { 
            background: rgba(13, 17, 23, 0.8); 
            backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.08); 
            border-radius: 1rem; 
            transition: 0.4s;
            position: relative;
            overflow: hidden;
        }
        
        /* ÿ™ÿ£ÿ´Ÿäÿ± ÿßŸÑÿ™ÿØÿßŸàŸÑ */
        .admin-card::after {
            content: ""; position: absolute; top: 0; left: 0; width: 2px; height: 100%;
            background: var(--glow-color, #3b82f6);
            box-shadow: 0 0 15px var(--glow-color, #3b82f6);
        }

        .tab-btn { padding: 12px; border-radius: 8px; font-weight: bold; transition: 0.3s; cursor: pointer; border: 1px solid transparent; }
        .tab-active { 
            background: rgba(212, 175, 55, 0.1); 
            color: #D4AF37; 
            border-color: #D4AF37;
            box-shadow: inset 0 0 15px rgba(212, 175, 55, 0.2);
        }
        
        .status-badge { padding: 4px 12px; border-radius: 4px; font-size: 9px; font-weight: 900; text-transform: uppercase; border: 1px solid currentColor; }
        
        .order-new { --glow-color: #3b82f6; } 
        .order-delayed { --glow-color: #facc15; animation: blink 2s infinite; } 
        .order-urgent { --glow-color: #ef4444; animation: blink 1s infinite; } 
        .order-completed { --glow-color: #22c55e; opacity: 0.8; } 
        .order-trouble { --glow-color: #a855f7; animation: blink 1.5s infinite; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        
        .btn-action { transition: 0.3s; cursor: pointer; border-radius: 6px; }
        .btn-action:hover { filter: brightness(1.3); transform: translateY(-1px); }

        .system-font { font-family: 'Space Mono', monospace; }
    </style>
</head>
<body class="p-4 pb-20">

    <header class="max-w-4xl mx-auto mb-8 flex justify-between items-center border-b border-white/10 pb-6">
        <div>
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-black text-white tracking-tighter uppercase italic">Al-Hut <span class="text-[#D4AF37]">Command</span></h1>
                <span class="bg-green-500/20 text-green-500 text-[8px] px-2 py-1 rounded border border-green-500/30 animate-pulse">LIVE SYSTEM</span>
            </div>
            <p class="text-slate-500 text-[10px] mt-1 font-mono uppercase tracking-[0.2em]">Quantum Management Terminal v4.0</p>
        </div>
        <div class="text-left">
            <button onclick="loadData()" class="bg-blue-500/10 text-blue-400 p-2 px-4 rounded border border-blue-500/30 hover:bg-blue-500/20 transition-all text-[10px] font-bold">
                <i class="fas fa-terminal ml-1"></i> REFRESH_SYNC
            </button>
        </div>
    </header>

    <div class="max-w-4xl mx-auto flex gap-2 mb-6">
        <button onclick="switchTab('orders')" id="btnOrders" class="tab-btn flex-1 tab-active text-[11px] uppercase tracking-widest">Orders_Stream üõ∞Ô∏è</button>
        <button onclick="switchTab('offices')" id="btnOffices" class="tab-btn flex-1 bg-white/5 text-slate-500 text-[11px] uppercase tracking-widest">Network_Nodes ü§ù</button>
    </div>

    <main class="max-w-4xl mx-auto space-y-4" id="content">
        <div class="text-center py-20 text-blue-500/40 font-mono text-xs animate-pulse">INITIALIZING SECURE LINK...</div>
    </main>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbznxCVbF350cer5qcXlIROrNmmnf5993r9-AoLbNKqb8YfVNhhT3rREefD7dbK6RFIH/exec";
        let currentTab = 'orders';
        let data = { orders: [], offices: [] };

        async function loadData() {
            try {
                const res = await fetch(`${scriptURL}?action=getAdminFullData&t=${Date.now()}`);
                data = await res.json();
                render();
            } catch (e) { 
                container.innerHTML = `<div class="text-center p-10 text-red-500 font-mono text-xs italic">CONNECTION_ERROR: STACK_OVERFLOW</div>`;
            }
        }

        function getOrderClass(status, timestamp) {
            if (status.includes('‚úÖ')) return 'order-completed';
            if (status.includes('‚ö†Ô∏è')) return 'order-trouble';
            const diff = Math.floor((new Date() - new Date(timestamp)) / 60000);
            if (status === "ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±") {
                if (diff > 30) return 'order-urgent';
                if (diff > 10) return 'order-delayed';
                return 'order-new';
            }
            return 'order-new';
        }

        function formatDateTime(ts) {
            if(!ts) return "00:00";
            const d = new Date(ts);
            return d.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: false});
        }

        function render() {
            const container = document.getElementById('content');
            if (currentTab === 'orders') {
                const trouble = data.orders.filter(o => o.status.includes('‚ö†Ô∏è'));
                const regular = data.orders.filter(o => !o.status.includes('‚ö†Ô∏è')).reverse();
                
                let html = "";
                if (trouble.length > 0) {
                    html += `<div class="mb-10 bg-red-500/5 p-2 rounded-lg border border-red-500/20">
                        <h2 class="text-red-500 font-bold text-[10px] uppercase mb-4 flex items-center gap-2 px-2 tracking-widest">
                            <i class="fas fa-radiation"></i> Conflict_Alerts (${trouble.length})
                        </h2>`;
                    html += trouble.map(o => renderOrderCard(o)).join('');
                    html += `</div>`;
                }
                html += regular.map(o => renderOrderCard(o)).join('');
                container.innerHTML = html || `<div class="text-center py-20 text-slate-700 font-mono text-xs italic">NO_DATA_STREAM</div>`;
            } else {
                container.innerHTML = [...data.offices].reverse().map(of => `
                    <div class="admin-card p-5 mb-3 border-r-4 ${of.status === 'ŸÜÿ¥ÿ∑' ? 'border-green-500' : 'border-red-500'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-md font-black text-white">${of.name}</h3>
                                <p class="text-[10px] text-slate-500 font-mono mt-1 uppercase">Node_ID: ${of.id} | Loc: ${of.city}</p>
                                <span class="status-badge mt-2 inline-block ${of.status==='ŸÜÿ¥ÿ∑'?'text-green-500':'text-red-500'}">${of.status}</span>
                            </div>
                            <div class="flex gap-2">
                                ${of.status !== 'ŸÜÿ¥ÿ∑' ? `<button onclick="action('approveOffice', '${of.id}')" class="btn-action bg-green-500 text-black p-2 px-4 rounded text-[10px] font-black">ACTIVATE</button>` : ''}
                                <button onclick="action('blockOffice', '${of.id}')" class="btn-action bg-white/5 text-orange-400 border border-orange-500/20 p-2 px-4 rounded text-[10px] font-bold">TERMINATE</button>
                                <button onclick="action('deleteOffice', '${of.id}')" class="btn-action bg-red-500/10 text-red-500 p-2 px-3 rounded text-[10px]"><i class="fas fa-trash-alt"></i></button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function renderOrderCard(o) {
            const statusClass = getOrderClass(o.status, o.timestamp);
            const isTrouble = o.status.includes('‚ö†Ô∏è');
            const isCompleted = o.status.includes('‚úÖ');
            
            return `
            <div class="admin-card p-5 mb-3 ${statusClass} transition-all hover:bg-white/[0.02]">
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-[10px] font-mono text-slate-500">[${formatDateTime(o.timestamp)}]</span>
                            <span class="status-badge ${isCompleted ? 'text-green-400' : isTrouble ? 'bg-red-500 text-black' : 'text-blue-400'}">
                                ${o.status}
                            </span>
                        </div>
                        <h3 class="text-lg font-black text-white italic tracking-tight">${o.car}</h3>
                        <p class="text-xs text-[#D4AF37] font-mono mt-1 tracking-widest">${o.price} IQD</p>
                        
                        <div class="mt-4 flex flex-wrap gap-x-6 gap-y-2 text-[10px] text-slate-400 font-bold uppercase">
                            <p><i class="far fa-id-badge ml-1 text-slate-600"></i> ${o.name}</p>
                            <p><i class="fas fa-satellite-dish ml-1 text-slate-600"></i> ${o.prov}</p>
                            <p><i class="fas fa-phone-alt ml-1 text-slate-600"></i> <a href="tel:${o.phone}" class="text-blue-400">${o.phone}</a></p>
                            <p><i class="fas fa-server ml-1 text-slate-600"></i> <span class="text-orange-500 font-black">${o.office || 'NULL'}</span></p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col gap-2 min-w-[110px]">
                        ${!isCompleted ? `
                            <button onclick="action('complete', '${o.id}')" class="btn-action bg-[#22c55e] text-black p-2 rounded font-black text-[9px] uppercase tracking-tighter">
                                Commit_Order
                            </button>
                        ` : ''}
                        
                        <button onclick="action('adminReset', '${o.id}')" class="btn-action bg-white/5 text-blue-400 border border-blue-500/20 p-2 rounded font-black text-[9px] uppercase tracking-tighter">
                            ${isTrouble ? 'Override_Reboot' : 'Re_Inject'}
                        </button>
                        
                        <button onclick="action('deleteOrder', '${o.id}')" class="btn-action bg-red-500/5 text-red-500/40 p-2 rounded text-[9px] hover:text-red-500">
                            WIPE_LOG
                        </button>
                    </div>
                </div>
            </div>`;
        }

        async function action(act, id) {
            let confirmMsg = "Execute System Command?";
            if(act === 'complete') confirmMsg = "Confirm Payment & Delivery?";
            if(act === 'deleteOrder') confirmMsg = "WIPE DATA PERMANENTLY?";
            
            if(!confirm(confirmMsg)) return;

            try {
                const res = await fetch(`${scriptURL}?action=${act}&id=${id}`);
                const result = await res.json();
                if(result.success) {
                    loadData();
                } else {
                    alert("ACCESS_DENIED: " + result.message);
                }
            } catch (e) { 
                alert("NETWORK_TIMEOUT_RETRYING..."); 
            }
        }

        function switchTab(t) {
            currentTab = t;
            document.getElementById('btnOrders').className = `tab-btn flex-1 ${t==='orders' ? 'tab-active' : 'bg-white/5 text-slate-500'}`;
            document.getElementById('btnOffices').className = `tab-btn flex-1 ${t==='offices' ? 'tab-active' : 'bg-white/5 text-slate-500'}`;
            render();
        }

        loadData();
        setInterval(loadData, 20000);
    </script>
</body>
</html>
