<!DOCTYPE html>
<html lang="ar" dir="rtl" id="htmlTag">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title id="docTitle">ØªÙ… Ø¨Ù†Ø¬Ø§Ø­ | Ø¹Ø§Ø¦Ù„Ø© Ø§Ù„Ø­ÙˆØª ğŸ‹âœ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&family=Poppins:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@dotlottie/player-component@latest/dist/dotlottie-player.mjs" type="module"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --main-theme: #002349; --accent-theme: #D4AF37; }
        body { font-family: 'Tajawal', 'Poppins', sans-serif; background: #f0f4f8; overflow-x: hidden; }
        .main-card { background: white; border-radius: 3.5rem; box-shadow: 0 25px 50px -12px rgba(0, 35, 73, 0.2); position: relative; z-index: 10; border-top: 12px solid var(--main-theme); }
        .bounce-in { animation: bounceIn 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        @keyframes bounceIn { 0% { opacity: 0; transform: scale(0.3) translateY(100px); } 100% { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div id="mainBox" class="max-w-md w-full main-card p-8 text-center bounce-in">
        <div class="flex justify-center mb-2">
            <dotlottie-player src="https://lottie.host/82823631-f923-4412-bd77-2e9154784411/6vR0FvI7oN.json" background="transparent" speed="1.2" style="width: 160px; height: 140px;" loop autoplay></dotlottie-player>
        </div>

        <h1 id="mainGreeting" class="text-3xl font-black mb-1" style="color: var(--main-theme);">---</h1>
        <h2 id="userNameDisplay" class="text-xl font-black mb-4" style="color: var(--accent-theme);">...</h2>

        <div class="bg-blue-50/50 p-4 rounded-3xl mb-6">
            <p id="statusMsg" class="text-blue-900 font-black text-sm leading-relaxed italic">---</p>
        </div>

        <p id="subInstruction" class="text-slate-500 font-bold text-xs px-4 leading-relaxed mb-6">---</p>

        <div class="bg-slate-50 p-6 rounded-[2.5rem] mb-8 border-2 border-dashed border-slate-200">
            <p id="orderLabel" class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">REFERENCE NUMBER</p>
            <p id="orderIDDisplay" class="text-2xl font-black tracking-tighter" style="color: var(--main-theme);">---</p>
            <div id="summaryText" class="text-[10px] font-bold text-green-600 mt-2 flex items-center justify-center gap-1">
                <i id="syncIcon" class="fas fa-satellite-dish animate-pulse"></i> <span id="syncText">...</span>
            </div>
        </div>

        <a id="backBtn" href="index.html" class="block w-full py-5 rounded-2xl font-black text-xl shadow-xl transition-all active:scale-95 text-white" style="background: var(--main-theme);">
            ---
        </a>
    </div>

    <script>
        const u = new URLSearchParams(window.location.search);
        const lang = u.get('lang') || 'ar';
        const type = u.get('service') === 'Ø²ÙØ§Ù' ? 'wedding' : (u.get('service') === 'ØªØ¯Ø±ÙŠØ¨ Ù‚ÙŠØ§Ø¯Ø©' ? 'training' : 'personal');
        const scriptURL = "https://script.google.com/macros/s/AKfycbznxCVbF350cer5qcXlIROrNmmnf5993r9-AoLbNKqb8YfVNhhT3rREefD7dbK6RFIH/exec";

        const configs = {
            training: { main: '#7c3aed', accent: '#D4AF37' },
            wedding: { main: '#be185d', accent: '#D4AF37' },
            personal: { main: '#002349', accent: '#D4AF37' }
        };

        const content = {
            ar: { greet: "ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!", status: "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¥Ù„Ù‰ Ø®ÙˆØ§Ø¯Ù… Ø§Ù„Ø­ÙˆØª...", sub: "Ø³ÙŠÙ‚ÙˆÙ… ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ø¨Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø®Ù„Ø§Ù„ Ø¯Ù‚Ø§Ø¦Ù‚.", sync: "ØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø±Ù‚Ù…ÙŠ", back: "Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", welcome: "Ø¹Ù…ÙŠÙ„Ù†Ø§ Ø§Ù„Ø¹Ø²ÙŠØ²", already: "ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø³Ø¨Ù‚Ø§Ù‹ âœ…", syncing: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸..." },
            ku: { greet: "Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ!", status: "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù†Øª Ù†ÛØ±Ø¯Ø±Ø§ Ø¨Û† Ø³ÛØ±Ú¤Û•Ø±ÛŒ Ø­ÙˆØª...", sub: "ØªÛŒÙ…ÛŒ Ù¾Ø´ØªÚ¯ÛŒØ±ÛŒ Ù„Û• Ù…Ø§ÙˆÛ•ÛŒ Ú†Û•Ù†Ø¯ Ø®ÙˆÙ„Û•Ú©ÛÚ©Ø¯Ø§ Ù¾Û•ÛŒÙˆÛ•Ù†Ø¯ÛŒØª Ù¾ÛÙˆÛ• Ø¯Û•Ú©Û•ÛŒÙ†.", sync: "Ø²Ø§Ù†ÛŒØ§Ø±ÛŒÛŒÛ•Ú©Ø§Ù† Ù¾Ø§Ø±ÛØ²Ø±Ø§ÙˆÙ†", back: "Ú¯Û•Ú•Ø§Ù†Û•ÙˆÛ• Ø¨Û† Ø³Û•Ø±Û•ØªØ§", welcome: "Ú©Ú•ÛŒØ§Ø±ÛŒ Ø¨Û•Ú•ÛØ²", already: "Ù¾ÛØ´ØªØ± Ù†ÛØ±Ø¯Ø±Ø§ÙˆÛ• âœ…", syncing: "Ø®Û•Ø±ÛŒÚ©ÛŒ Ù¾Ø§Ø±Ø§Ø³ØªÙ†Û•..." },
            tr: { greet: "Rezervasyon BaÅŸarÄ±lÄ±!", status: "Verileriniz Al-Hut sunucularÄ±na gÃ¶nderildi...", sub: "Destek ekibimiz birkaÃ§ dakika iÃ§inde sizinle iletiÅŸime geÃ§ecektir.", sync: "Dijital kayda senkronize edildi", back: "Ana Sayfaya DÃ¶n", welcome: "DeÄŸerli MÃ¼ÅŸterimiz", already: "Zaten kaydedildi âœ…", syncing: "Kaydediliyor..." },
            en: { greet: "Booking Successful!", status: "Your data has been sent to Al-Hut servers...", sub: "Our support team will contact you within minutes.", sync: "Synchronized with digital record", back: "Back to Home", welcome: "Valued Customer", already: "Already saved âœ…", syncing: "Saving now..." }
        };

        window.onload = () => {
            const c = configs[type] || configs.personal;
            const l = content[lang] || content.ar;
            const isRtl = (lang === 'ar' || lang === 'ku');

            document.documentElement.style.setProperty('--main-theme', c.main);
            document.documentElement.style.setProperty('--accent-theme', c.accent);
            document.getElementById('htmlTag').dir = isRtl ? 'rtl' : 'ltr';

            document.getElementById('mainGreeting').innerText = l.greet;
            document.getElementById('statusMsg').innerText = l.status;
            document.getElementById('subInstruction').innerText = l.sub;
            document.getElementById('backBtn').innerText = l.back;
            document.getElementById('syncText').innerText = l.syncing;
            document.getElementById('userNameDisplay').innerText = u.get('name') || l.welcome;

            // ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù Ø«Ø§Ø¨Øª Ù„Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØ£ØªÙ ID Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            let orderSeed = u.get('phone') + u.get('car') + u.get('total_price');
            let finalOrderID = u.get('order_id') || "HUT-" + btoa(orderSeed).substring(0, 6).toUpperCase();
            document.getElementById('orderIDDisplay').innerText = "#" + finalOrderID;

            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: [c.main, c.accent] });

            // Ø§Ù„ÙØ­Øµ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ù„Ø§ ØªÙƒØ±Ø± Ø§Ù„Ù€ fetch
            if (sessionStorage.getItem('order_sent_' + finalOrderID)) {
                console.log("Order already sent in this session.");
                document.getElementById('syncText').innerText = l.already;
                document.getElementById('syncIcon').className = "fas fa-check-double text-green-500";
                document.getElementById('syncIcon').classList.remove('animate-pulse');
                return;
            }

            const payload = {
                order_id: finalOrderID,
                name: u.get('name'),
                phone: u.get('phone'),
                province: u.get('province'),
                car: u.get('car'),
                days: u.get('days') || "1",
                addons: u.get('addon_display') || "None",
                total_price: u.get('total_price'),
                gender: u.get('gender'),
                age: u.get('age'),
                national_id: u.get('national_id'),
                license_no: u.get('license_no'),
                service: u.get('service'),
                location_link: u.get('location_link'),
                date: new Date().toLocaleString('en-GB')
            };

            // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„" Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø±Ø§Øª Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© Ø¬Ø¯Ø§Ù‹
            sessionStorage.setItem('order_sent_' + finalOrderID, 'pending');

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                body: JSON.stringify(payload)
            }).then(() => {
                // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­
                sessionStorage.setItem('order_sent_' + finalOrderID, 'true');
                document.getElementById('syncText').innerText = l.sync;
                document.getElementById('syncIcon').className = "fas fa-check-double text-green-500";
                document.getElementById('syncIcon').classList.remove('animate-pulse');
            }).catch(err => {
                sessionStorage.removeItem('order_sent_' + finalOrderID); // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙØ´Ù„ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
                document.getElementById('syncText').innerText = "Sync Error - Retry Refresh";
            });
        };
    </script>
</body>
</html>
