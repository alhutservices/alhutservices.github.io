<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุฑุงุฏุงุฑ ุงูุญูุช - ููุญุฉ ุงูููุงุชุจ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white min-h-screen p-4 pb-24">
    <header class="mb-8 p-4 bg-slate-900 rounded-[2rem] border-b-4 border-yellow-500 shadow-2xl">
        <h1 class="text-2xl font-black text-center">๐ ุฑุงุฏุงุฑ ุงูุญูุช</h1>
        <p id="officeName" class="text-center text-yellow-500 text-sm font-bold mt-1"></p>
    </header>

    <div id="orders" class="space-y-4">
        <div class="text-center p-10 text-slate-500">ุฌุงุฑู ุงูุจุญุซ ุนู ุทูุจุงุช...</div>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzujkqi1n4TXICqp7g-bBmAErnraR43JIvPdc2zPz0j6UobP-FHnED9-LxL9QF3IE_eqA/exec";
        const office = localStorage.getItem('whale_office');
        const city = localStorage.getItem('whale_city');

        if(!office) window.location.href = 'login.html';
        document.getElementById('officeName').innerText = `ููุชุจ ${office} | ${city}`;

        async function load() {
            try {
                const res = await fetch(`${scriptURL}?action=getAllOrders&t=${Date.now()}`);
                const data = await res.json();
                
                // ุชุตููุฉ ุงูุทูุจุงุช ุงูุฎุงุตุฉ ุจุงููุญุงูุธุฉ ูุงูุชู ูู ุชุณุชูู ุจุนุฏ
                const filtered = data.filter(o => o.province === city && o.status === "ููุฏ ุงูุงูุชุธุงุฑ");
                
                document.getElementById('orders').innerHTML = filtered.length ? filtered.map(o => `
                    <div class="bg-slate-900 p-6 rounded-[2rem] border-r-8 border-yellow-500 flex justify-between items-center shadow-lg">
                        <div>
                            <h3 class="font-black text-xl text-white">${o.car}</h3>
                            <p class="text-green-400 font-black text-lg mt-1">${o.price} ุฏ.ุน</p>
                            <p class="text-[10px] text-yellow-500 font-bold uppercase">${o.time}</p>
                        </div>
                        <div class="flex flex-col gap-2">
                            <button onclick="updateStatus('${o.id}', 'claim')" class="bg-white text-slate-900 px-6 py-2 rounded-xl font-black text-xs shadow-md">ุงุณุชูุงู</button>
                            <button onclick="updateStatus('${o.id}', 'requestCancel')" class="text-red-500 text-[10px] font-bold">ุฅูุบุงุก</button>
                        </div>
                    </div>
                `).join('') : '<div class="text-center p-10 text-slate-600">ูุง ุชูุฌุฏ ุทูุจุงุช ุฌุฏูุฏุฉ ุญุงููุงู</div>';
            } catch(e) { console.error(e); }
        }

        async function updateStatus(id, action) {
            const url = `${scriptURL}?action=${action}&id=${id}&office=${encodeURIComponent(office)}`;
            await fetch(url);
            alert(action === 'claim' ? "ุชู ุงุณุชูุงู ุงูุทูุจ!" : "ุชู ุฅูุบุงุก ุงูุทูุจ");
            load();
        }

        // ุชุญุฏูุซ ุชููุงุฆู ูู 10 ุซูุงูู ูุชุนููุถ ุบูุงุจ ุงูุชููุฌุฑุงู
        setInterval(load, 10000);
        load();
    </script>
</body>
</html>
